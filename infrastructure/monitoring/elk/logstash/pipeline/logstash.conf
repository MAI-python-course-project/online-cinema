# Logstash Pipeline Configuration
# Processes logs from Cinema microservices

input {
  # Receive logs from Filebeat
  beats {
    port => 5044
    codec => json
  }

  # Receive logs via TCP (JSON)
  tcp {
    port => 5000
    codec => json_lines
  }

  # Receive logs via HTTP
  http {
    port => 8080
    codec => json
  }
}

filter {
  # Parse timestamp
  date {
    match => ["timestamp", "ISO8601"]
    target => "@timestamp"
  }

  # Add tags based on service
  if [service] {
    mutate {
      add_tag => ["service:%{service}"]
    }
  }

  # Parse log level
  if [level] {
    mutate {
      lowercase => ["level"]
      add_tag => ["level:%{level}"]
    }
  }

  # Extract request ID for correlation
  if [request_id] {
    mutate {
      add_field => { "trace_id" => "%{request_id}" }
    }
  }

  # Parse Python tracebacks
  if [level] == "error" and [message] =~ /Traceback/ {
    mutate {
      add_tag => ["python_exception"]
    }
    
    grok {
      match => {
        "message" => "(?<traceback>Traceback.*)"
      }
    }
  }

  # Geoip for IP addresses
  if [remote_addr] {
    geoip {
      source => "remote_addr"
      target => "geoip"
    }
  }

  # Remove sensitive fields
  mutate {
    remove_field => ["password", "token", "api_key", "secret"]
  }
}

output {
  # Output to Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch-logs:9200"]
    index => "cinema-logs-%{+YYYY.MM.dd}"
    user => "elastic"
    password => "changeme"
  }

  # Output to stdout for debugging (disable in production)
  stdout {
    codec => rubydebug
  }

  # Output errors to separate index
  if [level] == "error" or [level] == "critical" {
    elasticsearch {
      hosts => ["elasticsearch-logs:9200"]
      index => "cinema-errors-%{+YYYY.MM.dd}"
      user => "elastic"
      password => "changeme"
    }
  }
}
