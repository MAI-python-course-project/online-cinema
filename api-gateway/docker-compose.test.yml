version: '3.8'

# Test environment with mock backend services
# Use: docker-compose -f docker-compose.test.yml up

services:
  # ============================================
  # Kong API Gateway
  # ============================================
  kong:
    image: kong:3.5-alpine
    container_name: test-kong
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /usr/local/kong/declarative/kong.yml
      KONG_PROXY_LISTEN: 0.0.0.0:8000
      KONG_ADMIN_LISTEN: 0.0.0.0:8001
      KONG_LOG_LEVEL: debug
      KONG_PLUGINS: bundled
    volumes:
      - ./kong/kong.yml:/usr/local/kong/declarative/kong.yml:ro
    ports:
      - "8000:8000"
      - "8001:8001"
    networks:
      - test-network

  # ============================================
  # NGINX
  # ============================================
  nginx:
    image: nginx:1.25-alpine
    container_name: test-nginx
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
    ports:
      - "80:80"
    depends_on:
      - kong
    networks:
      - test-network

  # ============================================
  # Mock Backend Services
  # ============================================

  # Mock Auth Service
  auth-service:
    image: mockserver/mockserver:latest
    container_name: test-auth-service
    environment:
      MOCKSERVER_PROPERTY_FILE: /config/mockserver.properties
      MOCKSERVER_INITIALIZATION_JSON_PATH: /config/auth-expectations.json
    volumes:
      - ./test/mocks/auth-expectations.json:/config/auth-expectations.json:ro
    ports:
      - "8100:8000"
    networks:
      - test-network

  # Mock User Service
  user-service:
    image: mockserver/mockserver:latest
    container_name: test-user-service
    volumes:
      - ./test/mocks/user-expectations.json:/config/user-expectations.json:ro
    ports:
      - "8101:8000"
    networks:
      - test-network

  # Mock Catalog Service
  catalog-service:
    image: mockserver/mockserver:latest
    container_name: test-catalog-service
    volumes:
      - ./test/mocks/catalog-expectations.json:/config/catalog-expectations.json:ro
    ports:
      - "8102:8000"
    networks:
      - test-network

  # Mock Search Service
  search-service:
    image: mockserver/mockserver:latest
    container_name: test-search-service
    volumes:
      - ./test/mocks/search-expectations.json:/config/search-expectations.json:ro
    ports:
      - "8103:8000"
    networks:
      - test-network

  # Mock Streaming Service
  streaming-service:
    image: mockserver/mockserver:latest
    container_name: test-streaming-service
    volumes:
      - ./test/mocks/streaming-expectations.json:/config/streaming-expectations.json:ro
    ports:
      - "8104:8000"
    networks:
      - test-network

  # Mock Analytics Service
  analytics-service:
    image: mockserver/mockserver:latest
    container_name: test-analytics-service
    volumes:
      - ./test/mocks/analytics-expectations.json:/config/analytics-expectations.json:ro
    ports:
      - "8105:8000"
    networks:
      - test-network

  # Mock Payment Service
  payment-service:
    image: mockserver/mockserver:latest
    container_name: test-payment-service
    volumes:
      - ./test/mocks/payment-expectations.json:/config/payment-expectations.json:ro
    ports:
      - "8106:8000"
    networks:
      - test-network

  # Mock Notification Service
  notification-service:
    image: mockserver/mockserver:latest
    container_name: test-notification-service
    volumes:
      - ./test/mocks/notification-expectations.json:/config/notification-expectations.json:ro
    ports:
      - "8107:8000"
    networks:
      - test-network

networks:
  test-network:
    driver: bridge
